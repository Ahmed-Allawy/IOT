<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOTFireBase</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
</head>
    <style>
        table, th, td {
         border: 1px solid black;
         border-collapse: collapse;
         border-color: #96D4D4;
         text-align: center;
       }
     </style>
 </head>
 <body>
     <p>
         <div id='tem'></div>
         <div id='hum'></div>
         <div id='soil'></div>
         <div id="message"><h1>ESP NOT CONNECTED ! :(</h1></div>
         <table>
           <tr>
             <th>Temperature</th>
             <th>Humidity</th>
             <th>Soil Moisture Percentage</th>
             <th>Time [minutes:seconde]</th>
           </tr>
           <tr>
             <td id='t0'>0</td>
             <td id='h0'>0</td>
             <td id='s0'>0</td>
             <td id='m0'>0</td>
           </tr>
           <tr>
             <td id='t1'>0</td>
             <td id='h1'>0</td>
             <td id='s1'>0</td>
             <td id='m1'>0</td>
           </tr>
           <tr>
             <td id='t2'>0</td>
             <td id='h2'>0</td>
             <td id='s2'>0</td>
             <td id='m2'>0</td>
           </tr>
           <tr>
             <td id='t3'>0</td>
             <td id='h3'>0</td>
             <td id='s3'>0</td>
             <td id='m3'>0</td>
           </tr>
           <tr>
             <td id='t4'>0</td>
             <td id='h4'>0</td>
             <td id='s4'>0</td>
             <td id='m4'>0</td>
           </tr>
           <tr>
             <td id='t5'>0</td>
             <td id='h5'>0</td>
             <td id='s5'>0</td>
             <td id='m5'>0</td>
           </tr>
           <tr>
             <td id='t6'>0</td>
             <td id='h6'>0</td>
             <td id='s6'>0</td>
             <td id='m6'>0</td>
           </tr>
           <tr>
             <td id='t7'>0</td>
             <td id='h7'>0</td>
             <td id='s7'>0</td>
             <td id='m7'>0</td>
           </tr>
           <tr>
             <td id='t8'>0</td>
             <td id='h8'>0 </td>
             <td id='s8'>0</td>
             <td id='m8'>0</td>
           </tr>
           <tr>
             <td id='t9'>0</td>
             <td id='h9'>0</td>
             <td id='s9'>0</td>
             <td id='m9'>0</td>
           </tr>
           <tr>
            <td id='t10'>0</td>
            <td id='h10'>0</td>
            <td id='s10'>0</td>
            <td id='m10'>0</td>
          </tr>
          <tr>
            <td id='t11'>0</td>
            <td id='h11'>0</td>
            <td id='s11'>0</td>
            <td id='m11'>0</td>
          </tr>
          <tr>
            <td id='t12'>0</td>
            <td id='h12'>0</td>
            <td id='s12'>0</td>
            <td id='m12'>0</td>
          </tr>
          <tr>
            <td id='t13'>0</td>
            <td id='h13'>0</td>
            <td id='s13'>0</td>
            <td id='m13'>0</td>
          </tr>
          <tr>
            <td id='t14'>0</td>
            <td id='h14'>0</td>
            <td id='s14'>0</td>
            <td id='m14'>0</td>
          </tr>
          <tr>
            <td id='t15'>0</td>
            <td id='h15'>0</td>
            <td id='s15'>0</td>
            <td id='m15'>0</td>
          </tr>
          <tr>
            <td id='t16'>0</td>
            <td id='h16'>0</td>
            <td id='s16'>0</td>
            <td id='m16'>0</td>
          </tr>
          <tr>
            <td id='t17'>0</td>
            <td id='h17'>0</td>
            <td id='s17'>0</td>
            <td id='m17'>0</td>
          </tr>
          <tr>
            <td id='t18'>0</td>
            <td id='h18'>0</td>
            <td id='s18'>0</td>
            <td id='m18'>0</td>
          </tr>
          <tr>
            <td id='t19'>0</td>
            <td id='h19'>0</td>
            <td id='s19'>0</td>
            <td id='m19'>0</td>
          </tr>
          <tr>
            <td id='t20'>0</td>
            <td id='h20'>0</td>
            <td id='s20'>0</td>
            <td id='m20'>0</td>
          </tr>
          <tr>
            <td id='t21'>0</td>
            <td id='h21'>0</td>
            <td id='s21'>0</td>
            <td id='m21'>0</td>
          </tr>
          <tr>
            <td id='t22'>0</td>
            <td id='h22'>0</td>
            <td id='s22'>0</td>
            <td id='m22'>0</td>
          </tr>
          <tr>
            <td id='t23'>0</td>
            <td id='h23'>0</td>
            <td id='s23'>0</td>
            <td id='m23'>0</td>
          </tr>
         </table> 
     </p>
 
 <!-- <canvas id="myChart" style="width:100%;max-width:700px"></canvas> -->
 <div id="chart-temperature" class="container"></div>
 <div id="chart-humidity" class="container"></div>
 </body>
    <script>
       var prevMunites = 0;
       var msg = document.getElementById("message");
       msg.hidden = true;
        function getData(){
           fetch('https://script.google.com/macros/s/AKfycbyki2HGIykdlCIr3JHCcjJenFhWyRTRnBEXrgcm1T_IAhKwZ8Hor9y51e480oXUDBc0/exec').then((result)=>{

            var data = result.json();
            console.log(data);
            return data;
            }).then((obj)=>{
            obj.length = 24;
            console.log(obj);
            return obj;
            }).then((data)=>{
               var obj =  data;
               console.log(obj[0].Munites +" "+prevMunites);
               if(prevMunites != obj[0].Munites){
                    drawChart(obj[0]);
                    fillTable(obj);
                    average(obj);
                    prevMunites = obj[0].Munites;
                    msg.hidden = true;
               }
              else {
                msg.hidden = false;
                msg.style.color = "red";
              }
               
            });
        }
       
    function average(obj){
            var temSum =0;
            var humSum =0;
            var soilSum =0;
            for(var i=0; i<24;i++){
            temSum += obj[i].Tem;
            humSum += obj[i].Hum;
            soilSum += obj[i].Soil;
            }
            document.getElementById('tem').innerText='average Temperature = '+temSum/24;
            document.getElementById('hum').innerText='average Humidity = '+humSum/24;
            document.getElementById('soil').innerText='average Soil = '+soilSum/24;
    } 
    function fillTable(obj){
          for(var i=0; i<24;i++){
            document.getElementById('t'+i).innerText = obj[i].Tem;
            document.getElementById('h'+i).innerText = obj[i].Hum;
            document.getElementById('s'+i).innerText = obj[i].Soil;
            document.getElementById('m'+i).innerText = obj[i].Date;
        }
        
  }
    function drawChart(obj){
        if(chartT.series[0].data.length > 24) {
        chartT.series[0].addPoint([obj.Date, obj.Soil], true, true, true);
        } 
        else {
                chartT.series[0].addPoint([obj.Date, obj.Soil], true, false, true);
            }
    }
  
    var chartT = new Highcharts.Chart({
        chart:{ renderTo : 'chart-temperature' },
        title: { text: 'BME280 Temperature' },
        series: [{
          showInLegend: false,
          data: []
        }],
        plotOptions: {
          line: { animation: false,
            dataLabels: { enabled: true }
          },
          series: { color: '#059e8a' }
        },
        xAxis: { type: 'datetime',
          dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
          title: { text: 'Temperature (Celsius)' }
          //title: { text: 'Temperature (Fahrenheit)' }
        },
        credits: { enabled: false }
      }); 
      getData();
      setInterval(function(){
        getData();
    },65000); 
    </script>
</html>